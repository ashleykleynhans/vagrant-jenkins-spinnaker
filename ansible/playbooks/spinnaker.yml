---
- hosts: all
  become: true

  environment:
    JAVA_HOME: /usr/lib/jvm/java-11-openjdk-amd64
    PATH: "{{ ansible_env.PATH }}:/usr/lib/jvm/java-11-openjdk-amd64/bin"
    TERM: vt100

  vars:
    spinnaker_storage_type: minio
    spinnaker_user: spinnaker
    spinnaker_group: spinnaker
    jvm_path: /usr/lib/jvm/java-11-openjdk-amd64/bin

  tasks:
    - name: Include task to install packages that enable apt over HTTPS
      ansible.builtin.include_tasks: includes/apt_over_https.yml

    - name: Include task to install useful packages
      ansible.builtin.include_tasks: includes/install_useful_packages.yml

    - name: Include task to install docker
      ansible.builtin.include_tasks: includes/install_docker.yml

    - name: Create spinnaker user group
      ansible.builtin.group:
        name: "{{ spinnaker_group }}"
        state: present

    - name: Create spinnaker user
      ansible.builtin.user:
        name: "{{ spinnaker_user }}"
        group: "{{ spinnaker_group }}"
        comment: Spinnaker user
        shell: /bin/bash
        create_home: yes
        state: present

    - name: Install Java
      ansible.builtin.apt:
        name: openjdk-11-jre-headless
        state: present

    # Does not set JAVA_HOME and fails as a result, so JAVA_HONE is set in environment above
    - name: Download Halyard Installation script
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/spinnaker/halyard/master/install/debian/InstallHalyard.sh
        dest: /tmp/InstallHalyard.sh
        owner: root
        group: root
        mode: 0755

    - name: Execute Halyard Installation script
      ansible.builtin.command: "/tmp/InstallHalyard.sh --user {{ spinnaker_user }} -y"

  # Setup a handler for restarting Docker daemon
  handlers:
    - name: restart docker
      ansible.builtin.service:
        name: docker
        state: restarted